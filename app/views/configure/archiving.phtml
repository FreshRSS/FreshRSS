<?php $this->partial('aside_configure'); ?>

<div class="post">
	<a href="<?php echo _url('index', 'index'); ?>"><?php echo _t('gen.action.back_to_rss_feeds'); ?></a>

	<form method="post" action="<?php echo _url('configure', 'archiving'); ?>">
		<input type="hidden" name="_csrf" value="<?php echo FreshRSS_Auth::csrfToken(); ?>" />
		<legend><?php echo _t('conf.archiving'); ?></legend>
		<p><?php echo _i('help'); ?> <?php echo _t('conf.archiving.help'); ?></p>

		<div class="form-group">
			<label class="group-name" for="ttl_default"><?php echo _t('conf.archiving.ttl'); ?></label>
			<div class="group-controls">
				<select class="number" name="ttl_default" id="ttl_default" required="required" data-leave-validation="<?php echo FreshRSS_Context::$user_conf->ttl_default; ?>"><?php
					$found = false;
					foreach (array(1200 => '20min', 1500 => '25min', 1800 => '30min', 2700 => '45min',
					                3600 => '1h', 5400 => '1.5h', 7200 => '2h', 10800 => '3h', 14400 => '4h', 18800 => '5h', 21600 => '6h', 25200 => '7h', 28800 => '8h',
					                36000 => '10h', 43200 => '12h', 64800 => '18h',
					                86400 => '1d', 129600 => '1.5d', 172800 => '2d', 259200 => '3d', 345600 => '4d', 432000 => '5d', 518400 => '6d',
					                604800 => '1wk') as $v => $t) {
						echo '<option value="' . $v . (FreshRSS_Context::$user_conf->ttl_default == $v ? '" selected="selected' : '') . '">' . $t . '</option>';
						if (FreshRSS_Context::$user_conf->ttl_default == $v) {
							$found = true;
						}
					}
					if (!$found) {
						echo '<option value="' . intval(FreshRSS_Context::$user_conf->ttl_default) . '" selected="selected">' . intval(FreshRSS_Context::$user_conf->ttl_default) . 's</option>';
					}
				?></select> (<?php echo _t('gen.short.by_default'); ?>)
			</div>
		</div>

		<p class="alert alert-warn">
			<?php echo _t('conf.archiving.policy_warning'); ?>
		</p>

		<div class="form-group">
			<label class="group-name"><?php echo _t('conf.archiving.policy'); ?></label>
			<div class="group-controls">
				<label class="checkbox" for="enable_retention_count_limit">
					<input type="checkbox" name="enable_retention_count_limit" id="enable_retention_count_limit" value="1"<?php echo FreshRSS_Context::$user_conf->archiving['enable_retention_count_limit'] ? ' checked="checked"' : ''; ?>  data-leave-validation="<?php echo FreshRSS_Context::$user_conf->archiving['enable_retention_count_limit']; ?>"/>
					<?php echo _t('conf.archiving.retention_count_limit'); ?>
					<input type="number" id="retention_count_limit" name="retention_count_limit" min="0" value="<?php echo empty($archiving['retention_count_limit']) ? 200 : $archiving['retention_count_limit']; ?>" data-leave-validation="<?php echo FreshRSS_Context::$user_conf->archiving['retention_count_limit']; ?>"/>
				</label>
			</div>
		</div>

		<div class="form-group">
			<div class="group-controls">
				<label class="checkbox" for="enable_retention_period">
					<input type="checkbox" name="enable_retention_period" id="enable_retention_period" value="1"<?php echo FreshRSS_Context::$user_conf->archiving['enable_retention_period'] ? ' checked="checked"' : ''; ?>  data-leave-validation="<?php echo FreshRSS_Context::$user_conf->archiving['enable_retention_period']; ?>"/>
					<?php echo _t('conf.archiving.retention_period'); ?>
					<input type="number" id="retention_period_count" name="retention_period_count" min="0" value="<?php echo FreshRSS_Context::$user_conf->volatile['retention_period_count']; ?>" data-leave-validation="<?php echo FreshRSS_Context::$user_conf->volatile['retention_period_count']; ?>"/>
					<select class="number" name="retention_period_unit" id="retention_period_unit" data-leave-validation="<?php echo FreshRSS_Context::$user_conf->volatile['retention_period_unit']; ?>">
						<option></option>
						<option value="P1Y" <?php echo 'P1Y' === FreshRSS_Context::$user_conf->volatile['retention_period_unit'] ? 'selected="selected"' : ''; ?>><?php echo _t('gen.period.years'); ?></option>
						<option value="P1M" <?php echo 'P1M' === FreshRSS_Context::$user_conf->volatile['retention_period_unit'] ? 'selected="selected"' : ''; ?>><?php echo _t('gen.period.months'); ?></option>
						<option value="P1W" <?php echo 'P1W' === FreshRSS_Context::$user_conf->volatile['retention_period_unit'] ? 'selected="selected"' : ''; ?>><?php echo _t('gen.period.weeks'); ?></option>
						<option value="P1D" <?php echo 'P1D' === FreshRSS_Context::$user_conf->volatile['retention_period_unit'] ? 'selected="selected"' : ''; ?>><?php echo _t('gen.period.days'); ?></option>
						<option value="PT1H" <?php echo 'PT1H' === FreshRSS_Context::$user_conf->volatile['retention_period_unit'] ? 'selected="selected"' : ''; ?>><?php echo _t('gen.period.hours'); ?></option>
					</select>
				</label>
			</div>
		</div>

		<div class="form-group">
			<label class="group-name"><?php echo _t('conf.archiving.exception'); ?></label>
			<div class="group-controls">
				<label class="checkbox" for="keep_favourites">
					<input type="checkbox" name="keep_favourites" id="keep_favourites" value="1"<?php echo FreshRSS_Context::$user_conf->archiving['keep_favourites'] ? ' checked="checked"' : ''; ?>  data-leave-validation="<?php echo FreshRSS_Context::$user_conf->archiving['keep_favourites']; ?>"/>
					<?php echo _t('conf.archiving.keep_favourites'); ?>
				</label>
			</div>
		</div>

		<div class="form-group">
			<div class="group-controls">
				<label class="checkbox" for="keep_labels">
					<input type="checkbox" name="keep_labels" id="keep_labels" value="1"<?php echo FreshRSS_Context::$user_conf->archiving['keep_labels'] ? ' checked="checked"' : ''; ?>  data-leave-validation="<?php echo FreshRSS_Context::$user_conf->archiving['keep_labels']; ?>"/>
					<?php echo _t('conf.archiving.keep_labels'); ?>
				</label>
			</div>
		</div>

		<div class="form-group">
			<div class="group-controls">
				<label class="checkbox" for="keep_unreads">
					<input type="checkbox" name="keep_unreads" id="keep_unreads" value="1"<?php echo FreshRSS_Context::$user_conf->archiving['keep_unreads'] ? ' checked="checked"' : ''; ?>  data-leave-validation="<?php echo FreshRSS_Context::$user_conf->archiving['keep_unreads']; ?>"/>
					<?php echo _t('conf.archiving.keep_unreads'); ?>
				</label>
			</div>
		</div>

		<div class="form-group form-actions">
			<div class="group-controls">
				<button type="submit" class="btn btn-important"><?php echo _t('gen.action.submit'); ?></button>
				<button type="reset" class="btn"><?php echo _t('gen.action.cancel'); ?></button>
			</div>
		</div>
	</form>

	<legend><?php echo _t('conf.archiving.maintenance'); ?></legend>
	<form method="post" action="<?php echo _url('entry', 'purge'); ?>">
		<input type="hidden" name="_csrf" value="<?php echo FreshRSS_Auth::csrfToken(); ?>" />

		<div class="form-group">
			<label class="group-name"><?php echo _t('conf.user.current'); ?></label>
			<div class="group-controls">
				<?php echo _t('conf.user.articles_and_size', format_number($this->nb_total), format_bytes($this->size_user)); ?>
			</div>
		</div>

		<div class="form-group">
			<div class="group-controls">
				<button type="submit" class="btn btn-important confirm"><?php echo _t('conf.archiving.purge_now'); ?></button>
			</div>
		</div>
	</form>
	<?php if (FreshRSS_Auth::hasAccess('admin')) { ?>
	<form method="post" action="<?php echo _url('entry', 'optimize'); ?>">
		<input type="hidden" name="_csrf" value="<?php echo FreshRSS_Auth::csrfToken(); ?>" />
		<div class="form-group">
			<label class="group-name"><?php echo _t('conf.user.users'); ?></label>
			<div class="group-controls">
				<?php echo format_bytes($this->size_total); ?>
			</div>
		</div>
		<div class="form-group">
			<div class="group-controls">
				<input type="hidden" name="optimiseDatabase" value="1" />
				<button type="submit" class="btn btn-important"><?php echo _t('conf.archiving.optimize'); ?></button>
				<?php echo _i('help'); ?> <?php echo _t('conf.archiving.optimize_help'); ?>
			</div>
		</div>
	</form>
	<?php } ?>
</div>
