<?php
/** @var FreshRSS_View $this */

$opml_array = array(
	'namespaces' => array(
		'frss' => FreshRSS_Export_Service::FRSS_NAMESPACE,
	),
	'head' => array(
		'title' => FreshRSS_Context::$system_conf->title,
		'dateCreated' => new DateTime(),
	),
	'body' => array()
);

foreach ($this->categories as $key => $cat) {
	$opml_array['body'][$key] = array(
		'text' => $cat->name(),
		'@outlines' => array()
	);

	foreach ($cat->feeds() as $feed) {
		$outline = [
			'text' => htmlspecialchars_decode($feed->name(), ENT_QUOTES),
			'type' => FreshRSS_Export_Service::TYPE_RSS_ATOM,
			'xmlUrl' => htmlspecialchars_decode($feed->url(), ENT_QUOTES),
			'htmlUrl' => htmlspecialchars_decode($feed->website(), ENT_QUOTES),
			'description' => htmlspecialchars_decode($feed->description(), ENT_QUOTES),
		];
		if ($feed->kind() === FreshRSS_Feed::KIND_HTML_XPATH) {
			$outline['type'] = FreshRSS_Export_Service::TYPE_HTML_XPATH;
			/** @var array<string,string> */
			$xPathSettings = $feed->attributes('xpath');
			$outline['frss:xPathItem'] = $xPathSettings['item'] ?? null;
			$outline['frss:xPathItemTitle'] = $xPathSettings['itemTitle'] ?? null;
			$outline['frss:xPathItemContent'] = $xPathSettings['itemContent'] ?? null;
			$outline['frss:xPathItemUri'] = $xPathSettings['itemUri'] ?? null;
			$outline['frss:xPathItemAuthor'] = $xPathSettings['itemAuthor'] ?? null;
			$outline['frss:xPathItemTimestamp'] = $xPathSettings['itemTimestamp'] ?? null;
			$outline['frss:xPathItemThumbnail'] = $xPathSettings['itemThumbnail'] ?? null;
			$outline['frss:xPathItemCategories'] = $xPathSettings['itemCategories'] ?? null;
		}
		if (!empty($feed->filtersAction('read'))) {
			$filters = '';
			foreach ($feed->filtersAction('read') as $filterRead) {
				$filters .= $filterRead->getRawInput() . "\n";
			}
			$filters = trim($filters);
			$outline['frss:filtersActionRead'] = $filters;
		}
		if ($feed->pathEntries() != '') {
			$outline['frss:cssFullContent'] = $feed->pathEntries();
		}
		$opml_array['body'][$key]['@outlines'][] = $outline;
	}
}

echo libopml_render($opml_array);
