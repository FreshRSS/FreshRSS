<?php $this->partial('aside_subscription'); ?>

<div class="post">
	<div class="link-back-wrapper">
		<a class="link-back" href="<?= _url('index', 'index') ?>"><?= _t('gen.action.back_to_rss_feeds') ?></a>
	</div>

	<h1><?= _t('admin.stats.main') ?></h1>

	<div class="stat-grid">
		<div class="stat half">
			<h2><?= _t('admin.stats.entry_repartition') ?></h2>
			<table>
				<thead>
					<tr>
						<th>Â </th>
						<th><?= _t('admin.stats.main_stream') ?></th>
						<th><?= _t('admin.stats.all_feeds') ?></th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th><?= _t('admin.stats.status_total') ?></th>
						<td class="numeric"><?= format_number($this->repartition['main_stream']['total']) ?></td>
						<td class="numeric"><?= format_number($this->repartition['all_feeds']['total']) ?></td>
					</tr>
					<tr>
						<th><?= _t('admin.stats.status_read') ?></th>
						<td class="numeric"><?= format_number($this->repartition['main_stream']['count_reads']) ?></td>
						<td class="numeric"><?= format_number($this->repartition['all_feeds']['count_reads']) ?></td>
					</tr>
					<tr>
						<th><?= _t('admin.stats.status_unread') ?></th>
						<td class="numeric"><?= format_number($this->repartition['main_stream']['count_unreads']) ?></td>
						<td class="numeric"><?= format_number($this->repartition['all_feeds']['count_unreads']) ?></td>
					</tr>
					<tr>
						<th><?= _t('admin.stats.status_favorites') ?></th>
						<td class="numeric"><?= format_number($this->repartition['main_stream']['count_favorites']) ?></td>
						<td class="numeric"><?= format_number($this->repartition['all_feeds']['count_favorites']) ?></td>
					</tr>
				</tbody>
			</table>
		</div><!--

		--><div class="stat half">
			<h2><?= _t('admin.stats.top_feed') ?></h2>
			<table>
				<thead>
					<tr>
						<th><?= _t('admin.stats.feed') ?></th>
						<th><?= _t('admin.stats.category') ?></th>
						<th><?= _t('admin.stats.entry_count') ?></th>
						<th><?= _t('admin.stats.percent_of_total') ?></th>
					</tr>
				</thead>
				<tbody>
					<?php foreach ($this->topFeed as $feed) { ?>
						<tr>
							<td><a href="<?= _url('stats', 'repartition', 'id', $feed['id']) ?>"><?= $feed['name'] ?></a></td>
							<td><?= $feed['category'] ?></td>
							<td class="numeric"><?= format_number($feed['count']) ?></td>
							<td class="numeric"><?= format_number($feed['count'] / $this->repartition['all_feeds']['total'] * 100, 1) ?></td>
						</tr>
					<?php } ?>
				</tbody>
			</table>
		</div>

		<div class="stat">
			<h2><?= _t('admin.stats.entry_per_day') ?></h2>
			<div>
				<canvas id="statsEntriesPerDay"></canvas>
			</div>
		</div>

		<div class="stat half">
			<h2><?= _t('admin.stats.feed_per_category') ?></h2>
			<div>
				<canvas id="statsFeedsPerCategory"></canvas>
			</div>
		</div>

		<div class="stat half">
			<h2><?= _t('admin.stats.entry_per_category') ?></h2>
			<div>
				<canvas id="statsEntriesPerCategory"></canvas>
			</div>
		</div>
	</div>
</div>

<script class="jsonData" type="application/json">
<?php
echo json_encode(array(
	'stats' => array (
		'canvasID' => 'statsEntriesPerDay',
		'config' => array(
			'type' => 'scatter',
			'data' => array(
				'datasets' => array(
					array(
						'type' => 'bar',
						'label' => _t('admin.stats.entry_per_day'),  // Todo: better i18n
						'backgroundColor' => '#0062BD',
						'borderColor' => '#0062BD',
						'data' => $this->entryCount,
						'barPercentage'=> 1.0,
    					'categoryPercentage' => 1.0,
						'order' => 2
					),
					array(
						'type' => 'line',
						'label' => 'Average ('.$this->average.')',  // Todo: i18n
						'borderColor' => 'rgb(192,216,0)',
						'data' => array (
							-30 => $this->average,
							-1 => $this->average,
						),
						'order' => 1
					),
				)
			),
			'options' => array(
				'scales' => array(
					'y' => array (
						'beginAtZero' => true,
					),
				),
				'elements' => array(
					'point' => array (
						'radius' => 0
					)
				)
			)
		)
	)
), JSON_UNESCAPED_UNICODE);
?></script>

<script class="jsonData" type="application/json">
<?php
echo json_encode(array(
	'stats' => array (
		'canvasID' => 'statsFeedsPerCategory',
		'config' => array(
			'type' => 'doughnut',
			'data' => array(
				'labels' => $this->feedByCategory['label'],
				'datasets' => array(
					array(
						'label' => _t('admin.stats.feed_per_category'),
						'backgroundColor' => array(
							'#0b84a5',  //petrol
							'#f6c85f', // sand
							'#6f4e7c', //purple
							'#9dd866', //green
							'#ca472f', //red
							'#ffa056', //orange
							'#8dddd0', // turkis
							'#f6c85f', // sand
							'#6f4e7c', //purple
							'#9dd866', //green
							'#ca472f', //red
							'#ffa056', //orange
							'#8dddd0' // turkis
						),
						'data' => $this->feedByCategory['data'],
					)
				)
			),
			'options' => array(
				'layout' => array(
					'padding' => 20
				),
				'plugins' => array(
					'legend' => array(
						'position' => 'bottom',
						'align' => 'start'
					)
				),
			)
		)
	)
), JSON_UNESCAPED_UNICODE);
?></script>

<script class="jsonData" type="application/json">
<?php
echo json_encode(array(
	'stats' => array (
		'canvasID' => 'statsEntriesPerCategory',
		'config' => array(
			'type' => 'doughnut',
			'data' => array(
				'labels' => $this->entryByCategory['label'],
				'datasets' => array(
					array(
						'label' => _t('admin.stats.entry_per_category'),
						'backgroundColor' => array(
							'#0b84a5',  //petrol
							'#f6c85f', // sand
							'#6f4e7c', //purple
							'#9dd866', //green
							'#ca472f', //red
							'#ffa056', //orange
							'#8dddd0', // turkis
							'#f6c85f', // sand
							'#6f4e7c', //purple
							'#9dd866', //green
							'#ca472f', //red
							'#ffa056', //orange
							'#8dddd0' // turkis
						),
						'data' => $this->entryByCategory['data'],
					)
				)
			),
			'options' => array(
				'layout' => array(
					'padding' => 20
				),
				'plugins' => array(
					'legend' => array(
						'position' => 'bottom',
						'align' => 'start'
					)
				),
			)
		)
	)
), JSON_UNESCAPED_UNICODE);
?></script>


<script src="../scripts/statsWithChartjs.js?<?= @filemtime(PUBLIC_PATH . '/scripts/statsWithChartjs.js') ?>"></script>
